<%@page import="java.sql.SQLException"%><%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%><%@ page import="java.sql.Connection" %><%@ page import="java.sql.PreparedStatement" %><%@ page import="java.sql.ResultSet" %><%@ page import="java.util.Hashtable" %><%@ page import="javax.naming.Context" %><%@ page import="javax.naming.InitialContext" %><%@ page import="javax.sql.DataSource" %><%//http://localhost:7001/HTML/HEL000.jspString sData 	= request.getParameter("sdata")==null ? "" :request.getParameter("sdata");String sCustId 	= request.getParameter("scust_id")==null ? "" :request.getParameter("scust_id");String sUsrId 	= request.getParameter("susr_id")==null ? "" :request.getParameter("susr_id");String sSaveYn  = request.getParameter("save_yn");String sQustCtt = request.getParameter("qust_ctt");//System.out.println(sData);//System.out.println(" sCustId :: " +sCustId + sCustId.length());//System.out.println(" sUsrId :: " + sUsrId);char[] rt = {24};char[] ct = {26};String rows = String.valueOf(rt);String cols = String.valueOf(ct);String[] rowData;String[] colData;Context ctx 				= null;DataSource ds 				= null;Connection conn 			= null;ResultSet rs 				= null;ResultSet rs1 				= null;PreparedStatement pstmt 			= null;PreparedStatement del_pstmt 		= null;PreparedStatement u_cmp_pstmt 		= null;PreparedStatement u_rsps_yn_pstmt 	= null;PreparedStatement s_rsps_yn_pstmt	= null;PreparedStatement s_rsps_ctt_pstmt	= null;StringBuffer query 					= new StringBuffer(100);StringBuffer del_query 				= new StringBuffer(100);StringBuffer tmp_cust_nm_data 		= new StringBuffer(100); //GSC임의고객번호StringBuffer u_cmp_query 			= new StringBuffer(100); //캠페인 목표건수 +1StringBuffer u_rsps_yn_query		= new StringBuffer(100); //고객응답여부StringBuffer s_rsps_yn_query		= new StringBuffer(100); //고객응답여부조회StringBuffer rsps_yn_data 			= new StringBuffer(100); //고객응답여부결과StringBuffer u_rsps_ctt_query 			= new StringBuffer(100); //고객응답 상담원 CTTStringBuffer u_rsps_ctt_data 			= new StringBuffer(100); //고객응답 상담원 CTTString saveFlag			= "";String msg				= "";String gscYn			= "";try{			Hashtable ht = new Hashtable();	ht.put(Context.INITIAL_CONTEXT_FACTORY, "weblogic.jndi.WLInitialContextFactory");		ht.put(Context.PROVIDER_URL, "t3://localhost:7001");		ctx = new InitialContext(ht);		ds = (DataSource)ctx.lookup("jdbc/gsntDS");	conn = ds.getConnection();		conn.setAutoCommit(false);		if (conn == null){		throw new Exception("Connection Fail");	}else{				rowData = sData.split(rows);			if(sCustId.length() == 0){			del_query.delete(0, del_query.length());			del_query.append("  SELECT FUN_GET_TMP_CUST_ID()     ");			del_query.append("    FROM DUAL   					 ");						del_pstmt = conn.prepareStatement(del_query.toString());							rs = del_pstmt.executeQuery();					while(rs.next()){				tmp_cust_nm_data.append(rs.getString(1));			}					gscYn = "Y";		}else{			colData = rowData[0].split(cols);						//캠페인대상고객 응답 여부 조회			s_rsps_yn_query.delete(0, s_rsps_yn_query.length());			s_rsps_yn_query.append("  SELECT QUST_RSPS_YN     		");					s_rsps_yn_query.append("    FROM TBL_CMP_TGT_CUST   	");			s_rsps_yn_query.append("   WHERE CUST_ID = ?  			");						s_rsps_yn_query.append("   AND CMP_ID = ?  			");							s_rsps_yn_pstmt = conn.prepareStatement(s_rsps_yn_query.toString());						s_rsps_yn_pstmt.setString(1,sCustId);	//고객번호			s_rsps_yn_pstmt.setString(2,colData[18]);	//캠페인ID 						//System.out.println("query[" + s_rsps_yn_query.toString() + "]");									rs1 = s_rsps_yn_pstmt.executeQuery();					while(rs1.next()){				rsps_yn_data.append(rs1.getString(1));			}                  //상담원 비고 업데이트			u_rsps_ctt_query.delete(0, u_rsps_ctt_query.length());			u_rsps_ctt_query.append("  UPDATE TBL_CMP_TGT_CUST     		");			u_rsps_ctt_query.append("    SET CTT = ?  	");			u_rsps_ctt_query.append("   WHERE CMP_ID = ?  			");						u_rsps_ctt_query.append("   AND   CUST_ID = ?  			");			      			s_rsps_ctt_pstmt = conn.prepareStatement(u_rsps_ctt_query.toString());					  s_rsps_ctt_pstmt.setString(1,sQustCtt);	//비고 내용 						s_rsps_ctt_pstmt.setString(2,colData[18]);	//캠페인ID 			  		s_rsps_ctt_pstmt.setString(3,sCustId);	//고객 번호 		          			//System.out.println("query[" + u_rsps_ctt_query.toString() + "]");									s_rsps_ctt_pstmt.executeQuery();				//기존에 등록된 설문응답 삭제				del_query.delete(0, del_query.length());									del_query.append("  DELETE                           ");			del_query.append("    FROM TBL_QUST_RSPS_RSLT_DTLS   ");			del_query.append("   WHERE QUST_SEQ_NO = ? 			 ");			del_query.append("     AND RSPT_ID = ? 				 ");						del_pstmt = conn.prepareStatement(del_query.toString());						del_pstmt.setString(1,colData[0]);	//설문일련번호 delete			del_pstmt.setString(2,sCustId);	//설문일련번호 delete				//System.out.println("query[" + del_query.toString() + "]");					del_pstmt.execute();						//캠페인 테이블 목표 건수 + 1		    if("N".equals(rsps_yn_data.toString())){				u_cmp_query.delete(0, u_cmp_query.length());								u_cmp_query.append("  UPDATE      TBL_CMP_INFO                           						");				u_cmp_query.append("     SET      GOAL_ACVMT_NCNT		= NVL(GOAL_ACVMT_NCNT,0) + 1   		 	");				u_cmp_query.append("   			, LST_CORC_ID   		= ?										");				u_cmp_query.append("   			, LST_CORC_DTM  		= TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 	");				u_cmp_query.append("   WHERE      CMP_ID 				= ? 									");							u_cmp_pstmt = conn.prepareStatement(u_cmp_query.toString());				u_cmp_pstmt.setString(1,sUsrId);		//수정자				u_cmp_pstmt.setString(2,colData[18]);	//캠페인ID 								u_cmp_pstmt.execute();								//캠페인 대상 고객테이블 설문응답여부 Y				u_cmp_query.delete(0, u_rsps_yn_query.length());								u_rsps_yn_query.append("  UPDATE      TBL_CMP_TGT_CUST                           					");				u_rsps_yn_query.append("     SET      QUST_RSPS_YN			= ?   		 						");				u_rsps_yn_query.append("   			, LST_CORC_ID   		= ?										");				u_rsps_yn_query.append("   			, LST_CORC_DTM  		= TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 	");				u_rsps_yn_query.append("   WHERE      CMP_ID 				= ? 									");				u_rsps_yn_query.append("     AND      CUST_ID 				= ?										");								u_rsps_yn_pstmt = conn.prepareStatement(u_rsps_yn_query.toString());        u_rsps_yn_pstmt.setString(1,sSaveYn);		//설문 yn				u_rsps_yn_pstmt.setString(2,sUsrId);		//수정자				u_rsps_yn_pstmt.setString(3,colData[18]);	//캠페인ID 				u_rsps_yn_pstmt.setString(4,sCustId);		//고객번호				 				//System.out.println("query[" + u_rsps_yn_query.toString() + "]");      				u_rsps_yn_pstmt.execute();		    }		}					for(int i=0; i<rowData.length; i++) {			colData = rowData[i].split(cols);			query.delete(0, query.length());			query.append("INSERT INTO TBL_QUST_RSPS_RSLT_DTLS( 	");			query.append("			  QUST_SEQ_NO		");			query.append("			, QITM_SEQ_NO		");			query.append("			, ITEM_SEQ			");									query.append("			, OBJT_RSPS			");			query.append("			, SBJT_RSPS			");			query.append("			, CMP_ID			");			query.append("			, RSPT_ID			");			query.append("			, REG_ID			");			query.append("			, LST_CORC_ID		");			query.append("			, REG_DTM			");						query.append("			, LST_CORC_DTM		");			query.append("			)VALUES(		 	");			query.append("			?,?,?,?,?,?,?,?,?		");						query.append("			,TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')");			query.append("			,TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')");			query.append("			)									 ");							pstmt = conn.prepareStatement(query.toString());						pstmt.setString(1,colData[0]);						//설문일련번호			pstmt.setString(2,colData[1]);						//문항일련번호			pstmt.setString(3,colData[10]);						//보기번호				pstmt.setString(4,colData[14]);						//객관식응답			pstmt.setString(5,colData[15]);						//주관식응답			pstmt.setString(6,colData[18]);						//캠페인ID							if(sCustId.length() == 0){				pstmt.setString(7,tmp_cust_nm_data.toString());	//고객Id				pstmt.setString(8,"GSC");						//등록자				pstmt.setString(9,"GSC");						//수정자			}else{				pstmt.setString(7,sCustId);						//고객Id				pstmt.setString(8,sUsrId);						//등록자				pstmt.setString(9,sUsrId);						//수정자			}						pstmt.execute();			/*System.out.println(" [0]  :: " + colData[0]);			System.out.println(" [1]  :: " + colData[1]);			System.out.println(" [10] :: " + colData[10]);			System.out.println(" [14] :: " + colData[14]);			System.out.println(" [15] :: " + colData[15]);			System.out.println(" [18] :: " + colData[18]);*/			//System.out.println("query[" + query.toString() + "]");					}		conn.commit();		saveFlag = "Y";	}	}catch (SQLException e) {	if(conn!=null)try{conn.rollback();}catch(SQLException sqle){}	saveFlag = "N";	msg = e.toString();}catch (Exception e) {	if(conn!=null)try{conn.rollback();}catch(SQLException sqle){}	saveFlag = "N";	msg = e.toString();}finally{	conn.setAutoCommit(true);	if (pstmt!=null){try{pstmt.close();}catch(SQLException ex){}}	if (conn!=null){try{conn.close();}catch(SQLException ex){}}}%><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=EUC-KR"><script language="javascript">var save_flag = "<%=saveFlag%>";if(save_flag == "Y"){	alert("저장 되었습니다.");}else if(save_flag == "N"){          	alert("저장에 실패했습니다. 관리자에게 문의 해주십시오.");	}function window_close(){	if("<%=gscYn%>" == "Y"){		parent.close();			}else{	}}</script></head><body> </body></html>